name: Auto Instagram Poster

on:
  schedule:
    - cron: "0 10 * * *"
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install "huggingface_hub>=0.14.1" requests pillow openai

      - name: HF Router smoke test
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          SD_MODEL: ${{ secrets.SD_MODEL }}
        run: |
          set -euo pipefail
          echo "=== huggingface_hub version ==="
          python3 << 'EOF'
          import huggingface_hub as h
          print(h.__version__)
          EOF
          echo "=== Relevant env vars ==="
          env | grep -E 'HF_|SD_MODEL' || true
          echo "=== Repo grep for provider usage (should be none) ==="
          git grep -n "provider=" || true
          git grep -n "replicate" || true
          git grep -n "api-inference.huggingface.co" || true
          echo "=== Router test: InferenceClient text_to_image ==="
          python3 << 'EOF'
          import os, sys
          from huggingface_hub import InferenceClient
          token = os.environ.get("HF_TOKEN")
          if not token:
              print("HF_TOKEN missing")
              sys.exit(2)
          client = InferenceClient(token=token)
          model = os.environ.get("SD_MODEL") or "black-forest-labs/FLUX.1-schnell"
          print("Testing model:", model)
          try:
              img = client.text_to_image("A small red circle", model=model)
              print("Router test OK, returned type:", type(img))
          except Exception as e:
              print("Router test failed:", e)
              raise
          EOF

      - name: Run bot to generate image + caption
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_MODEL: ${{ secrets.HF_MODEL }}
          SD_MODEL: ${{ secrets.SD_MODEL }}
        run: |
          echo "HF_MODEL=${HF_MODEL:-not-set}"
          echo "SD_MODEL=${SD_MODEL:-not-set}"
          python bot.py

      - name: Commit working model and caption
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add working_model.txt caption.txt || true
          git commit -m "Persist working model and caption" || echo "No changes to commit"
          git push || echo "Push failed (maybe no changes or permissions)"

      - name: Verify output files exist
        run: |
          if [ ! -f output.jpg ]; then
            echo "❌ Image not generated"
            ls -la
            exit 1
          fi
          if [ ! -f caption.txt ]; then
            echo "❌ Caption not generated"
            ls -la
            exit 1
          fi

      - name: Move generated image into images folder
        run: |
          mkdir -p images
          mv output.jpg images/post.jpg

      - name: Commit new image
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add images/post.jpg
          git commit -m "Add new Instagram image" || echo "No changes to commit"
          git push || echo "Push failed (maybe no changes or permissions)"

      - name: Read caption
        id: caption
        run: |
          echo "caption<<EOF" >> $GITHUB_OUTPUT
          cat caption.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate public GitHub URL
        id: url
        run: |
          RAW_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/images/post.jpg"
          echo "url=$RAW_URL" >> $GITHUB_OUTPUT

      - name: Post to Instagram
        env:
          IG_USER_ID: ${{ secrets.IG_USER_ID }}
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}
          IMAGE_URL: ${{ steps.url.outputs.url }}
          CAPTION: ${{ steps.caption.outputs.caption }}
        run: |
          echo "Creating media container..."
          CREATE_RESPONSE=$(curl -s -X POST \
            "https://graph.facebook.com/v24.0/${IG_USER_ID}/media" \
            -F "image_url=${IMAGE_URL}" \
            -F "caption=${CAPTION}" \
            -F "access_token=${IG_ACCESS_TOKEN}")

          echo "Response: $CREATE_RESPONSE"
          CREATION_ID=$(echo $CREATE_RESPONSE | python3 -c "import sys, json; print(json.load(sys.stdin).get('id', ''))")

          if [ -z "$CREATION_ID" ]; then
            echo "❌ Failed to create media container"
            exit 1
          fi

          echo "Publishing..."
          curl -s -X POST \
            "https://graph.facebook.com/v24.0/${IG_USER_ID}/media_publish" \
            -F "creation_id=${CREATION_ID}" \
            -F "access_token=${IG_ACCESS_TOKEN}"

      - name: Prune old images (keep last 10)
        run: |
          ls -t images | sed -e '1,10d' | xargs -I {} rm images/{} || true
          git add images || true
          git commit -m "Prune old images" || echo "Nothing to prune"
          git push || echo "Push failed (maybe no changes or permissions)"
